library(haven)
library(ggplot2)
library(dplyr)
library(grf)
library(gridExtra)
library(arrow)
library(dplyr)
library(readr)
library(haven)
library(lubridate)
library(tictoc)
library(tidyr)
library(DoubleML)
library(data.table)
library(DoubleML)
library(mlr3)
library(mlr3learners)
library(data.table)
library(TSstudio)
library(janitor)
library(fastDummies)
set.seed(2)




###############Estimation ATE



path="C:/Users/dalil.youcefi/Documents/Formation et retour à l'emploi/Données/"



var_quel=c("emploi_quelconque_t_plus_3","emploi_quelconque_t_plus_6",  "emploi_quelconque_t_plus_12" ,"emploi_quelconque_t_plus_18" ,"emploi_quelconque_t_plus_24","emploi_quelconque_t_plus_36")




cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_%s.rds",paste0("2017-09-01","_","emploi_quelconque_t_plus_18"))))

blp=best_linear_projection(cf,cf$X.orig[,c("age", "anciennete","sexe","zone_urbaine","handicap" )])

library(stargazer)

stargazer(blp)

data_res=data.frame(matrix(0,nrow=54,ncol=1))


data_res[,1]=as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))

colnames(data_res)[1]="cohorte"



data_std=data.frame(matrix(0,nrow=54,ncol=1))


data_std[,1]=as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))

colnames(data_std)[1]="cohorte"




for (var in var_quel){
  
  
  li=c()
  li2=c()
  for (cohorte in as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))){
    
    
    
    
    
    
    print(cohorte)
    
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Toutes Form/cf_%s.rds",paste0(cohorte,"_",var))))
    
    li=append(li,average_treatment_effect(cf)[1])
    li2=append(li2,average_treatment_effect(cf)[2])
    
  }
  
  
  data_res=cbind(data_res,li)
  colnames(data_res)[length(colnames(data_res))]=paste0("ate_",var)
  
  data_std=cbind(data_std,li2)
  colnames(data_std)[length(colnames(data_std))]=paste0("std_",var)
  
  
  
}


write.csv(cbind(data_res,data_std),paste0(path,"Résultats/tab_toutes_form_cf.csv"))















data_res=data.frame(matrix(0,nrow=54,ncol=1))


data_res[,1]=as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))

colnames(data_res)[1]="cohorte"



data_std=data.frame(matrix(0,nrow=54,ncol=1))


data_std[,1]=as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))

colnames(data_std)[1]="cohorte"




for (var in var_quel){
  
  
  li=c()
  li2=c()
  for (cohorte in as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))){
    
    
    
    
    
    
    print(cohorte)
    
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif2_%s.rds",paste0(cohorte,"_",var))))
    
    li=append(li,average_treatment_effect(cf)[1])
    li2=append(li2,average_treatment_effect(cf)[2])
    
  }
  
  
  data_res=cbind(data_res,li)
  colnames(data_res)[length(colnames(data_res))]=paste0("ate_",var)
  
  data_std=cbind(data_std,li2)
  colnames(data_std)[length(colnames(data_std))]=paste0("std_",var)
  
  
  
}


write.csv(cbind(data_res,data_std),paste0(path,"Résultats/tab_cf_ceritf.csv"))



















####BLP formation certifiante





li_cov=c("age", "anciennete","sexe","zone_urbaine","handicap" )

for (var in c("emploi_quelconque_t_plus_18")){


  
  
  for (cohorte in as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))){


    print(cohorte)
    
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif3_%s.rds",paste0(cohorte,"_",var))))
    
    

    blp=(best_linear_projection(cf,cf$X.orig[,li_cov],target="overlap",vcov.type="HC1"))
    
    write.csv(cbind(blp[,],confint(blp)),paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_blp_bas_cov_%s.csv",paste0(cohorte,"_",var))))
    
    
   
  }
  
 
}









######GATE nivfor

li_cov=c(   "nivfor1","nivfor2","nivfor3","nivfor4"   )

for (var in c("emploi_quelconque_t_plus_18")){
  
  
  
  
  for (cohorte in as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))){
    
    
    print(cohorte)
    res=data.frame(matrix(0,ncol=3, nrow=length(li_cov)+1))
    
    row.names(res)=append(li_cov,"nivfor0")
    colnames(res)=c("ATE","Upp","Low")
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif3_%s.rds",paste0(cohorte,"_",var))))
    col=colnames(cf$X.orig)
    
    for (cov in col[col%in% li_cov]){
      a=cf$X.orig[,cov]==1
      
      ate=average_treatment_effect(cf,subset=a)[1]
      std=average_treatment_effect(cf,subset=a)[2]
      
      upp=ate + qnorm(0.975)*std
      low=ate-qnorm(0.975)*std
      
      res[cov,]=c(ate,upp,low)
      
      
    }
    
    
    a=rowSums(cf$X.orig[,col[col%in% li_cov] ])==0
    ate=average_treatment_effect(cf,subset=a)[1]
    std=average_treatment_effect(cf,subset=a)[2]
    
    upp=ate + qnorm(0.975)*std
    low=ate-qnorm(0.975)*std
    
    res["nivfor0",]=c(ate,upp,low)
    
    
    
    
    write.csv(res,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_blp_nivfor_%s.csv",paste0(cohorte,"_",var))))
    
    
    
  }
  
  
}











li_cov=c(      'romeAgriculture',
               'romeArts',
               'romeBanquassur',
               'romeBTP',
               'romeComm.et.medias',
               'romeCommerce.et.vente',
               'romeIndustrie',
               'romeLoisirs.Tourisme',
               'romeMaintenance.Installation',
               'romeSante',
               'romeServices.a.la.personne',
               'romeSpectacle')



####GATE ROME

for (var in c("emploi_quelconque_t_plus_18")){
  
  
  
  
  for (cohorte in as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))){
    
    
    print(cohorte)
    res=data.frame(matrix(0,ncol=3, nrow=length(li_cov)+1))

    row.names(res)=append(li_cov,"nivfor0")
    colnames(res)=c("ATE","Upp","Low")
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif3_%s.rds",paste0(cohorte,"_",var))))
    col=colnames(cf$X.orig)
    
    for (cov in col[col%in% li_cov]){
    a=cf$X.orig[,cov]==1
    
    ate=average_treatment_effect(cf,subset=a)[1]
    std=average_treatment_effect(cf,subset=a)[2]
    
    upp=ate + qnorm(0.975)*std
    low=ate-qnorm(0.975)*std
    
    res[cov,]=c(ate,upp,low)
    
    
    }
    
    
    a=rowSums(cf$X.orig[,col[col%in% li_cov] ])==0
    ate=average_treatment_effect(cf,subset=a)[1]
    std=average_treatment_effect(cf,subset=a)[2]
    
    upp=ate + qnorm(0.975)*std
    low=ate-qnorm(0.975)*std
    
    res["romeinconnu",]=c(ate,upp,low)
    
    
    
    
    write.csv(res,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_blp_rome_%s.csv",paste0(cohorte,"_",var))))
    
    
    
  }
  
  
}


####Analyse 25% les moins traités 25% le plus traités 

li_cov=grepl("age|anciennete|zone_urbaine|nivfor|sexe|handicap",colnames(cf$X.orig))


for (var in c("emploi_quelconque_t_plus_18")){
  
  
  
  
  for (cohorte in as.character(seq(ym('2017-01'), ym('2021-06'), by = '1 month'))){
    
    
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif3_%s.rds",paste0(cohorte,"_",var))))

    tau.hat <- predict(cf)$predictions
    high.effect <- tau.hat > quantile(tau.hat,0.75)
    
    low.effect <- tau.hat < quantile(tau.hat,0.25)
    ate.high <- average_treatment_effect(cf, subset = high.effect)
    ate.low <- average_treatment_effect(cf, subset = low.effect)
    







      
    li_high=colMeans(cf$X.orig[high.effect,li_cov])
    li_low=colMeans(cf$X.orig[low.effect,li_cov])
    
    li_high=append(li_high,ate.high)
    li_low=append(li_low,ate.low)
    
    write.csv(li_high,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_charac_high_%s.csv",paste0(cohorte,"_",var))))
    write.csv(li_low,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_charac_low_%s.csv",paste0(cohorte,"_",var))))
    
    
  }
}








