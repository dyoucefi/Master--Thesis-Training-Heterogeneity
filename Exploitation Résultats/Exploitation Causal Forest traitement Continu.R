library(haven)
library(ggplot2)
library(dplyr)
library(grf)
library(gridExtra)
library(arrow)
library(dplyr)
library(readr)
library(haven)
library(lubridate)
library(tictoc)
library(tidyr)
library(DoubleML)
library(data.table)
library(DoubleML)
library(mlr3)
library(mlr3learners)
library(data.table)
library(TSstudio)
library(janitor)
library(fastDummies)
set.seed(2)




###############Estimation ATE



path="C:/Users/dalil.youcefi/Documents/Formation et retour à l'emploi/Données/"













#####################











######################PLR


li_cov=c("age", "anciennete","sexe","zone_urbaine","handicap" )

for (var in c("emploi_quelconque_t_plus_18")){
  
  
  
  
  for (cohorte in as.character(seq(ym('2017-09'), ym('2017-09'), by = '1 month'))){
    
    
    print(cohorte)
    
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_h_%s.rds",paste0(cohorte,"_",var))))     
    
    
    
    blp=(best_linear_projection(cf,cf$X.orig[,li_cov],target="overlap",vcov.type="HC1"))
    
    write.csv(cbind(blp[,],confint(blp)),paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_blp_bas_cov_h_%s.csv",paste0(cohorte,"_",var))))
    
    
    
  }
  
  
}














li_cov=c(   "nivfor1","nivfor2","nivfor3","nivfor4"   )

for (var in c("emploi_quelconque_t_plus_18")){
  
  
  
  
  for (cohorte in as.character(seq(ym('2017-09'), ym('2017-09'), by = '1 month'))){
    
    
    print(cohorte)
    res=data.frame(matrix(0,ncol=3, nrow=length(li_cov)+1))
    
    row.names(res)=append(li_cov,"nivfor0")
    colnames(res)=c("ATE","Upp","Low")
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_h_%s.rds",paste0(cohorte,"_",var))))     
    col=colnames(cf$X.orig)
    
    for (cov in col[col%in% li_cov]){
      a=cf$X.orig[,cov]==1
      
      ate=average_treatment_effect(cf,subset=a)[1]
      std=average_treatment_effect(cf,subset=a)[2]
      
      upp=ate + qnorm(0.975)*std
      low=ate-qnorm(0.975)*std
      
      res[cov,]=c(ate,upp,low)
      
      
    }
    
    
    a=rowSums(cf$X.orig[,col[col%in% li_cov] ])==0
    ate=average_treatment_effect(cf,subset=a)[1]
    std=average_treatment_effect(cf,subset=a)[2]
    
    upp=ate + qnorm(0.975)*std
    low=ate-qnorm(0.975)*std
    
    res["nivfor0",]=c(ate,upp,low)
    
    
    
    
    write.csv(res,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_blp_nivfor_h_%s.csv",paste0(cohorte,"_",var))))
    
    
    
  }
  
  
}









######################PLR


li_cov=c(      'romeAgriculture',
               'romeArts',
               'romeBanquassur',
               'romeBTP',
               'romeComm.et.medias',
               'romeCommerce.et.vente',
               'romeIndustrie',
               'romeLoisirs.Tourisme',
               'romeMaintenance.Installation',
               'romeSante',
               'romeServices.a.la.personne',
               'romeSpectacle')

for (var in c("emploi_quelconque_t_plus_18")){
  
  
  
  
  for (cohorte in as.character(seq(ym('2017-09'), ym('2017-09'), by = '1 month'))){
    
    
    print(cohorte)
    res=data.frame(matrix(0,ncol=3, nrow=length(li_cov)+1))
    
    row.names(res)=append(li_cov,"nivfor0")
    colnames(res)=c("ATE","Upp","Low")
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_h_%s.rds",paste0(cohorte,"_",var))))     
    col=colnames(cf$X.orig)
    
    for (cov in col[col%in% li_cov]){
      a=cf$X.orig[,cov]==1
      
      ate=average_treatment_effect(cf,subset=a)[1]
      std=average_treatment_effect(cf,subset=a)[2]
      
      upp=ate + qnorm(0.975)*std
      low=ate-qnorm(0.975)*std
      
      res[cov,]=c(ate,upp,low)
      
      
    }
    
    
    a=rowSums(cf$X.orig[,col[col%in% li_cov] ])==0
    ate=average_treatment_effect(cf,subset=a)[1]
    std=average_treatment_effect(cf,subset=a)[2]
    
    upp=ate + qnorm(0.975)*std
    low=ate-qnorm(0.975)*std
    
    res["romeinconnu",]=c(ate,upp,low)
    
    
    
    
    write.csv(res,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_blp_rome_h_%s.csv",paste0(cohorte,"_",var))))
    
    
    
  }
  
  
}




li_cov=grepl("age|anciennete|zone_urbaine|nivfor|sexe|handicap",colnames(cf$X.orig))


for (var in c("emploi_quelconque_t_plus_18")){
  
  
  
  
  for (cohorte in as.character(seq(ym('2017-09'), ym('2017-09'), by = '1 month'))){
    
    
    cf=readRDS(paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_h_%s.rds",paste0(cohorte,"_",var))))     
    
    tau.hat <- predict(cf)$predictions
    high.effect <- tau.hat > quantile(tau.hat,0.75)
    
    low.effect <- tau.hat < quantile(tau.hat,0.25)
    ate.high <- average_treatment_effect(cf, subset = high.effect)
    ate.low <- average_treatment_effect(cf, subset = low.effect)
    
    
    
    
    
    
    
    
    
    li_high=colMeans(cf$X.orig[high.effect,li_cov])
    li_low=colMeans(cf$X.orig[low.effect,li_cov])
    
    li_high=append(li_high,ate.high)
    li_low=append(li_low,ate.low)
    
    write.csv(li_high,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_charac_high_h_%s.csv",paste0(cohorte,"_",var))))
    write.csv(li_low,paste0(path,sprintf("Résultats/R/CF/Certif/cf_certif_charac_low_h_%s.csv",paste0(cohorte,"_",var))))
    
    
  }
}

